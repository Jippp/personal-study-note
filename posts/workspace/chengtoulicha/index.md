---
date: 2025-01-22
title: 大智慧预警通项目中城投利差需求的复盘
category: workspace
tags:
- workspace
- review
description: 复盘城投利差需求，找到问题，复盘和总结
---

# 需求背景

该需求是对旧版城投利差的一个改造和优化

## 开发遇到的难点

1. 大批量并发请求前端的限制

列表的数据是一列一列拼出来的，所以可能会出现大批量的并发请求，浏览器的内存会大量占用，导致页面卡顿。

解决方案：前端对大批量的并发请求做了限制，页面loading 不给交互，然后一次最多发6个请求，一直等到全部请求完之后页面loading取消 才能开始交互。当然这也是和产品沟通后的结果。

具体的代码实现：通过计数和阻塞队列来实现。当请求数大于限制数时，会通过一个**await Promise**阻止继续往下执行；等到有请求完成，计数减一，然后执行阻塞队列中的Promise，才会继续发其他请求。

> [!NOTE]
> 具体看[这里](/posts/fontend/solutions/requestLimit)

2. 页面的优化：请求的优化

页面大致两部分，左侧的待展示树，右侧的已展示树，这两个树是可以互相添加，比如从待展示树选中一些节点添加到已展示树这类操作。问题就在这是可以批量操作的，然后树节点可能携带的信息很多，如果一次批量添加很多的树节点，接口会卡，页面迟迟得不到响应，用户体验不好。

解决方案：和接口沟通后，提供新的接口，只需要传节点的id，接口去redis中读取存储的信息，这样就快很多。

3. 全量渲染改为增量渲染

也是树节点的问题，存储了太多信息，进入页面时如果接口一次性把数据都返回，会很慢。

解决方案：由全量返回改成了前端增量处理。树节点展示时或者需要操作的时候 再去调接口获取相关数据信息存到前端来。避免了全量数据带来的问题。

4. 其他性能问题

这里的性能问题都比较普通了，最终解决方案都是通过React的优化来解决的。比如添加memo、组件传参使用useMemo、useCallback包裹等、loading等切换通过样式而不是三元表达式(会导致组件被卸载然后重新渲染，如果是很重的组件就会有性能问题)等。
