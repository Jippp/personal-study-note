<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>

  <h1>Hello!</h1>
  
  <!-- 导航 -->
  <div id="nav"></div>
  <!-- 内容 -->
  <div id="container"></div>

  <!-- 微前端控制逻辑 -->
  <script type="text/javascript">
    /* 
      隔离类
      维护子应用的隔离
      创建、激活、销毁隔离实例
    */
    class MicroAppSandbox {
      // 配置信息 root id url scriptText 
      options = null;
      // iframe实例
      iframe = null;
      // iframe的window对象实例
      iframeWindow = null;
      // 是否执行过js
      exec = false

      constructor(options) {
        this.options = options
        this.iframe = this.createIframe()
        this.iframeWindow = this.iframe.contentWindow
      }

      createIframe() {
        const { rootElm, id, url } = this.options
        const iframe = window.document.createElement('iframe')

        const attrs = {
          // 空白页会让当前iframe继承父浏览上下文的源
          src: 'about:blank',
          'app-id': id,
          'app-src': url,
          style: 'border: none; width: 100%; height: 100%'
        }

        Object.keys(attrs).forEach(attrName => {
          iframe.setAttribute(attrName, attrs[attrName])
        })
        rootElm?.appendChild(iframe)
        return iframe
      }

      // 激活
      active() {
        this.iframe.style.display = 'block'
        if(this.exec) return;
        this.exec = true

        if(this.iframeWindow) {
          const scriptElement = this.iframeWindow.document.createElement('script')
          scriptElement.textContent = this.options.scriptText
          this.iframeWindow.document.head.appendChild(scriptElement)
        }
      }
      // 失活
      inactive() {
        this.iframe.style.display = 'none'
      }
      // 销毁
      destory() {
        this.options = null
        this.exec = false
        if(this.iframe) {
          this.iframe.parentNode?.removeChild(this.iframe)
          // this.iframe.remove()
        }
        this.iframe = null
      }
    }

    /* 
      管理单个子应用的类
      请求和缓存子应用的资源
      激活子应用
    */
    class MicroApp {
      // 子应用的script文本
      scriptText = ''
      // 隔离实例 MicroAppSandbox实例
      sandbox = null
      // 子应用挂载的根节点
      rootElm = null
      app = null;

      constructor(rootElm, app) {
        this.rootElm = rootElm
        this.app = app;
      }

      // 获取JS文本
      async fetchScript(scriptSrc) {
        try {
          const res = await window.fetch(scriptSrc)
          return await res.text()
        } catch (error) {
          console.error(error)
        }
      }

      // 激活子应用
      async active() {
        // script文本的缓存
        if(!this.scriptText) {
          this.scriptText = await this.fetchScript(this.app.script)
        }
        // 隔离实例的创建
        if(!this.sandbox) {
          this.sandbox = new MicroAppSandbox({
            rootElm: this.rootElm,
            scriptText: this.scriptText,
            url: this.app.url,
            id: this.app.id
          })
        }

        // 激活
        this.sandbox.active()
      }

      inactive() {
        this.sandbox?.inactive()
      }
    }

    /* 
      管理全部子应用的类
      预加载、添加和删除子应用
    */
    class MicroApps {
      // 子应用实例MicroApp实例映射表
      appsMap = new Map()
      // 子应用挂载的根节点信息 即内容区域
      rootElm = null

      constructor(rootElm, apps) {
        this.rootElm = rootElm
        this.setAppMaps(apps)
      }

      setAppMaps(apps) {
        apps.forEach(app => {
          this.appsMap.set(app.id, new MicroApp(this.rootElm, app))
        })
      }
      // prefetch预获取子应用
      prefetchApps() {
        // TODO
      }

      // 激活子应用
      activeApp(id) {
        const app = this.appsMap.get(id)
        app?.active()
      }
      // 失活子应用
      inactiveApp(id) {
        const app = this.appsMap.get(id)
        app?.inactive()
      }
    }

    /* 
      管理主应用的类
      获取子应用列表信息
      创建子应用导航
      切换子应用事件
    */
    class MainApp {
      microApps = []
      microAppsManager = null

      constructor() {
        this.init()
      }

      async init() {
        // 从服务器拿到子应用列表
        this.microApps = await this.fetchMicroApps()
        // 根据子应用列表创建导航
        this.createNav()
        this.navClickListener()
        this.hashChangeListener()
        // 创建管理子应用的实例
        this.microAppsManager = new MicroApps(
          document.getElementById('container'),
          this.microApps
        )
      }

      // 从主应用服务器获取到子应用列表信息
      async fetchMicroApps() {
        try {
          const res = await window.fetch('/microapps', {
            method: 'post'
          })
          return await res.json()
        } catch (error) {
          console.error(error)
        }
      }

      // 根据子应用列表创建导航
      createNav(microApps) {
        const fragment = new DocumentFragment()
        this.microApps?.forEach(microApp => {
          const button = document.createElement('button')
          button.textContent = microApp.name
          button.id = microApp.id
          fragment.appendChild(button)
        })
        // 添加到页面#nav元素上
        nav.appendChild(fragment)
      }

      // 监听导航的点击事件
      navClickListener() {
        const nav = document.getElementById('nav')
        nav.addEventListener('click', (e) => {
          // 通过修改hash来切换子应用
          window.location.hash = e.target?.id
        })
      }

      hashChangeListener() {
        window.addEventListener('hashchange', () => {
          this.microApps?.forEach(async ({ id }) => {
            if(id === window.location.hash.replace('#', '')) {
              this.microAppsManager.activeApp(id)
            }else {
              this.microAppsManager.inactiveApp(id)
            }
          })
        })
      }
      
    }


    /* 
      启动主应用时：
      1. 从服务器获取子应用列表信息，创建导航，并添加导航的跳转事件
      2. 实例化管理所有子应用的类
      
    */
    new MainApp()
  </script>

</body>
</html>