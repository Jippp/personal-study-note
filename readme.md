# 介绍

版本更新后，页面实时提示更新弹窗

思路：

sharedWorker中使用轮询，判断版本是否更新，更新后打开弹窗即可。

1. init注册
2. start开始轮询，获取etag/last-modified。判断资源是否变化，毕竟资源没有变化 版本号更新也没有意义
3. 构建时生成版本号release，放在public/release.json里。并且需要将版本号写入`.env`文件中，通过构建工具注入到环境变量内，方便后面的获取。
4. worker里通过接口拿到版本号之后，判断服务端返回的版本号(最新的)和当前本地的版本号是否一致，一致就没更新，否则就说明更新了
5. 全局注册弹窗组件，根据状态来判断弹窗是否需要打开。

当升级了一个新版本：

1. 页面资源会变化，版本号也会变化
2. 但是由于用户本地没有刷新页面，使用的是本地缓存，还是旧的资源，所以只需要比较用户本地的版本号以及轮询时拿到的最新版本号，不一致说明更新。

## 该项目的文件介绍

- version_back：服务，主要功能就是提供文件访问的能力，并且提供了`/release`接口可以获取到最新的版本号
- version_font：极简前端demo，在sharedWorker内轮询判断资源是否更新，更新后获取最新版本号，判断是否是新版本，如果是新版本弹出更新提示弹窗。

## 操作步骤

- 首先在`version_font`内执行`pnpm run build`命令进行构建
- 然后在`version_back`下执行`pnpm run serve`启动服务，在浏览器中访问`http://localhost:5174`。
- 再回到`version_font`随便改一下内容，再执行`pnpm run build`
- 回到浏览器等待 看是否有更新提示弹窗。

## 优化

能用轮询 就能用websocket，毕竟轮询发送请求的频率是不好控制的。
但是同样的，如果websocket，服务端也不好知道什么时候会有更新，除非监控文件夹变化，本质还是轮询，只是将轮询的压力放到了服务端。